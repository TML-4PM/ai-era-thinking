<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title id="title">Book — Tech for Humanity</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; margin:0; color:#111}
    header{padding:24px 16px; border-bottom:1px solid #eee}
    .wrap{max-width:900px; margin:0 auto}
    h1{font-size:28px; margin:0}
    .sub{color:#666; margin:4px 0 0}
    .lead{margin:16px 0; color:#333}
    .hero{width:100%; height:260px; object-fit:cover; background:#ddd; border-radius:12px}
    .pill{display:inline-block; padding:4px 8px; font-size:12px; border:1px solid #ddd; border-radius:999px; margin-right:8px}
    section{margin:24px 0}
    .chapter{border:1px solid #eee; border-radius:10px; padding:12px; margin:12px 0}
    .chapter h3{margin:0 0 8px}
    .small{font-size:13px; color:#666}
    .ul{margin:6px 0 0 18px}
    a.btn{display:inline-block; padding:8px 10px; font-size:13px; border:1px solid #111; border-radius:8px; text-decoration:none; color:#111; background:#fff}
    .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <a class="btn" href="/books/index.html">← All books</a>
      <h1 id="bookTitle"></h1>
      <p class="sub" id="bookSubtitle"></p>
    </div>
  </header>

  <main class="wrap">
    <img id="cover" class="hero" alt="Book cover">
    <p class="lead" id="lead"></p>

    <section>
      <div class="toolbar">
        <span class="pill" id="progressPill">Progress: 0%</span>
        <span class="pill">Series: Tech for Humanity</span>
        <a class="btn" id="editLink" href="#">Edit in CMS</a>
      </div>
    </section>

    <section>
      <h2>Chapters</h2>
      <div id="chapters"></div>
    </section>

    <section>
      <h2>Next actions</h2>
      <ul id="nextActions">
        <li>Add chapter outlines.</li>
        <li>Attach sources and figures.</li>
        <li>Wire status to Supabase when ready.</li>
      </ul>
    </section>
  </main>

  <!-- data -->
  <script src="/books/books.js"></script>
  <script>
    const q = new URLSearchParams(location.search);
    const slug = q.get('slug') || '';
    const book = window.findBookBySlug(slug);

    if(!book){
      document.getElementById('bookTitle').textContent = "Not found";
      document.getElementById('bookSubtitle').textContent = "";
    } else {
      document.title = `${book.title} — Tech for Humanity`;
      document.getElementById('bookTitle').textContent = book.title;
      document.getElementById('bookSubtitle').textContent = book.subtitle;
      document.getElementById('lead').textContent = book.lead;
      const img = document.getElementById('cover');
      img.src = book.cover || '/assets/covers/placeholder.jpg';
      img.onerror = () => img.src = '/assets/covers/placeholder.jpg';

      const avg = (arr) => !arr.length ? 0 :
        Math.round(arr.reduce((a,c)=>a+(c.progress||0),0)/arr.length);
      const pct = avg(book.chapters || []);
      const pill = document.getElementById('progressPill');
      pill.textContent = `Progress: ${pct}%`;
      pill.style.borderColor = pct>=90?'#16a34a':pct>=50?'#eab308':'#ef4444';
      pill.style.color      = pill.style.borderColor;

      document.getElementById('editLink').href = `/admin/books/${book.slug}`;

      const mount = document.getElementById('chapters');
      (book.chapters||[]).forEach((ch, idx)=>{
        const el = document.createElement('article');
        el.className = 'chapter';
        const sections = (ch.sections||[]).map(s=>`<li>${s}</li>`).join('');
        el.innerHTML = `
          <h3>${idx+1}. ${ch.title}</h3>
          <p class="small">Progress: ${ch.progress||0}%</p>
          ${sections ? `<ul class="ul">${sections}</ul>` : `<p class="small">No sections yet.</p>`}
        `;
        mount.appendChild(el);
      });

      if(!(book.chapters||[]).length){
        const el = document.createElement('p');
        el.className = 'small';
        el.textContent = 'No chapters yet.';
        mount.appendChild(el);
      }
    }
  </script>
</body>
</html>